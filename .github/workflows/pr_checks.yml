name: PR Checks

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  analyze:
    name: Analyze & Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch Flutter config
        id: fvm
        uses: kuhnroyal/flutter-fvm-config-action@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ steps.fvm.outputs.FLUTTER_VERSION }}
          channel: ${{ steps.fvm.outputs.FLUTTER_CHANNEL }}
          cache: true
          cache-key: "flutter-Linux-${{ steps.fvm.outputs.FLUTTER_VERSION }}"
          pub-cache-key: "flutter-pub-Linux-${{ steps.fvm.outputs.FLUTTER_VERSION }}"

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run lean_builder build --delete-conflicting-outputs

      - name: Check formatting
        run: dart format --set-exit-if-changed .

      - name: Analyze (strict)
        run: flutter analyze

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch Flutter config
        id: fvm
        uses: kuhnroyal/flutter-fvm-config-action@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ steps.fvm.outputs.FLUTTER_VERSION }}
          channel: ${{ steps.fvm.outputs.FLUTTER_CHANNEL }}
          cache: true
          cache-key: "flutter-Windows-${{ steps.fvm.outputs.FLUTTER_VERSION }}"
          pub-cache-key: "flutter-pub-Windows-${{ steps.fvm.outputs.FLUTTER_VERSION }}"

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run lean_builder build --delete-conflicting-outputs

      - name: Analyze
        run: flutter analyze --no-fatal-infos

      - name: Build Windows
        run: flutter build windows --release

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch Flutter config
        id: fvm
        uses: kuhnroyal/flutter-fvm-config-action@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ steps.fvm.outputs.FLUTTER_VERSION }}
          channel: ${{ steps.fvm.outputs.FLUTTER_CHANNEL }}
          cache: true
          cache-key: "flutter-macOS-${{ steps.fvm.outputs.FLUTTER_VERSION }}"
          pub-cache-key: "flutter-pub-macOS-${{ steps.fvm.outputs.FLUTTER_VERSION }}"

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run lean_builder build --delete-conflicting-outputs

      - name: Analyze
        run: flutter analyze --no-fatal-infos

      - name: Build macOS
        run: flutter build macos --release

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev

      - name: Fetch Flutter config
        id: fvm
        uses: kuhnroyal/flutter-fvm-config-action@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ steps.fvm.outputs.FLUTTER_VERSION }}
          channel: ${{ steps.fvm.outputs.FLUTTER_CHANNEL }}
          cache: true
          cache-key: "flutter-Linux-${{ steps.fvm.outputs.FLUTTER_VERSION }}"
          pub-cache-key: "flutter-pub-Linux-${{ steps.fvm.outputs.FLUTTER_VERSION }}"

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run lean_builder build --delete-conflicting-outputs

      - name: Analyze
        run: flutter analyze --no-fatal-infos

      - name: Build Linux
        run: flutter build linux --release
